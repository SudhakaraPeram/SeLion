<div class="selion-content-div">
  <h1 id="getting-started-with-seLion" class="page-header">SeLion's Enhanced Grid</h1>

  <p class="lead">How to setup and use SeLion's Enhanced Grid.</p>

  <h2 id="introduction">Introduction</h2>
  <p>
    The SeLion client component is compatible with any <a href="https://code.google.com/p/selenium/wiki/Grid2">Selenium Grid2</a>.
      That said, we have also published our own enhanced grid as the server component of SeLion. At a high level it in includes a
      few additions to make managing and setting up your own grid a bit easier.
  </p>
  <ol>
    <li>Dependency Downloader - Download Selenium dependencies -- the jars, various drivers, etc at startup.</li>
    <li>Auto Upgrade Nodes - Upgrade the Selenium, IE Driver, Chrome Driver,
        PhantomJS binary in each node without impacting existing test case execution.</li>
    <li>Force Restart Node - Forcibly restart the node without logging in to the physical node.</li>
    <li>Auto Restart Node - Recycles the node after a pre-defined number of unique sessions are finished to avoid unexpected
      issues.</li>
    <li>View Node Logs - Grid provides the ability to view all the registered node log files.</li>
    <li>Transfer Servlet aka "SeLion Hub Storage" - Upload and download zip files to the Hub for use with tests.</li>
  </ol>

  <h2 id="prerequisites">Prerequisites</h2>
  <p>Install the following software on your grid machines:</p>
  <ol>
    <li><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html">Java
      JDK 1.7</a> and configure the <code>JAVA_HOME</code> environment variable on your system</li>
    <li>You can obtain the latest version of SeLion's Enhanced Grid
      <a href="https://github.com/paypal/SeLion/releases/download/v1.2.0/SeLion-Grid-1.2.0-jar-with-dependencies.jar">here</a>.
      Alternatively, if you <a href="#buildingSelion">compiled SeLion</a> locally, copy the file
      <code>SeLion-Grid-{version}-jar-with-dependencies.jar</code> from <code>server/target/</code> and paste it to your
      working folder.
    </li>
  </ol>

  <h2 id="supportedPlatforms">Supported Platforms</h2>
  <p>SeLion Enhanced Grid is tested on these platforms:</p>
  <ol>
    <li>Red Hat Enterprise Linux</li>
    <li>Ubuntu</li>
    <li>Windows</li>
    <li>Mac</li>
  </ol>
  <h2 id="start-selion-grid">Start the Grid Hub</h2>
  <p>The grid hub serves as the central point. It will receive all test case requests from all
      clients and distribute them to the nodes registered with the grid.</p>
  <p>Open the command prompt and navigate to the location of the grid jar file. Type in the following command.</p>

  <pre><code class="language-sh">java -jar SeLion-Grid-{version}-jar-with-dependencies.jar -role hub</code></pre>

  <p>
      The grid hub will start up using the port <var>4444</var> by default. You can view it by connecting
      to <kbd>http://localhost:4444</kbd> with your preferred browser. By default all the required files will be downloaded or
      extracted to the directory <var>&lt;user.home&gt;/.selion</var>. You can specify a different directory with the system
      property <code>-DselionHome=&lt;folderPath&gt;</code>.
  </p>

  <h2 id="start-selion-node">Start the Grid Node</h2>
  <p>The grid node will execute the test cases.</p>
  <p>Open the command prompt and navigate to the location of the grid jar file. Type in the following command.</p>

  <pre><code class="language-sh">java -jar SeLion-Grid-{version}-jar-with-dependencies.jar -role node -hub http://localhost:4444/grid/register</code></pre>

  <p>
      The grid node will start up using the port <var>5555</var> by default. Once it is started,
      it will register with the grid hub. You can view the node detail in the
      grid console at <kbd>http://localhost:4444/grid/console</kbd>.
  </p>

  <p>The grid console should look like the following screen shot:</p>

  <div class="container">
      <img src="../images/grid-console.jpg" alt="View of the Grid console">
  </div>
  <br>
  <p>
      <b>Note:</b> The example shown uses the same machine for both the grid and the node. However, you can spawn any
      number of nodes (one node per machine) and register them to a central grid hub.
  </p>

  <h2>Using the SeLion's Enhanced Grid to Run Tests</h2>
  <p>
      To learn how to create a web based test, refer to <a href="#getting-started">Getting
      Started With SeLion</a>.
  </p>
  <p>To run tests against the grid you spawned, update the following in your TestNG <samp>SampleSuite.xml</samp> file</p>
  <ol>
      <li><code>runLocally</code> - Indicates that SeLion should use a remote grid</li>
      <li><code>seleniumhost</code> - Points to the IP/machine name where the grid hub is running.</li>
  </ol>

  <pre data-src="../sample-files/selionGrid-sample1.xml" data-line="5-8" class="line-numbers"></pre>

  <p>Now run the following command in the project directory path from a command prompt.</p>

  <pre><code class="language-sh">mvn clean test -DsuiteXmlFile=src/test/resources/SampleSuite.xml</code></pre>

  <p>A browser window will open on the machine where your node is running.</p>

  <h2 id="selion-config">SeLion Grid Configuration File</h2>
  <p>
    The SeLion Grid config JSON file allows you to configure the additional components in SeLion Grid. Once you start a
    Node for the first time, the file will be available in <code>$SELION_HOME/config/SeLionConfig.json</code>.
    Optionally, you can specify a different file with the <code>-selionConfig</code> argument.
  </p>
  <ol>
    <li><code>restartCycle</code> - Restart cycle will check at the specified interval and restart the server if it is down.
      Units in milliseconds.</li>
    <li><code>uniqueSessionCount</code> - Number of unique sessions before automatically recycling the node. <i>Default: 50</i></li>
    <li><code>customProcessHandler</code> - Process handler will be used to identify and kill the child processes spawned
      by a node. This handler should implement the interface <code>com.paypal.selion.utils.process.ProcessHandler</code></li>
    <li><code>artifactMaxFileSize</code> - Maximum file size allowed for any artifact uploaded to the SeLion Grid hub
      storage. Units in bytes.</li>
    <li><code>artifactExpiryInMilliSec</code> - Artifact will be removed from hub storage after the expiration time.</li>
    <li><code>managedArtifact</code> - ManagedArtifact represents a basic artifact successfully saved to SeLion Grid
      by an HTTP POST method call. It should implement the interface
      <code>com.paypal.selion.grid.servlets.transfer.ManagedArtifact</code></li>
    <li><code>managedArtifactBaseDir</code> - ManagedArtifactBaseDir represents the directory under <code>$SELION_HOME</code>,
      where the artifact is saved. This configuration can be overridden by using JVM argument
      <code>-DmanagedArtifactBaseDir=&lt;baseDirectory&gt;</code>. The default directory is <code>$SELION_HOME/repository</code>.</li>
  </ol>
  <h2>Sample SeLionConfig.json File</h2>
  <pre data-src="../sample-files/SeLionConfig.json" class="language-markup"></pre>

  <h2>Grid Management Console</h2>
  <p>
      If you have a large grid, managing the nodes can become tedious. The Enhanced Grid management console
      allows you access to various servlets that can perform actions such as force restarting, auto upgrade nodes, etc.
      Navigate to the management console via the url <kbd>http://localhost:4444/grid/admin/LoginServlet</kbd> to access
      these servlets. Default username and password is <kbd>admin</kbd>. Once logged in, you will see this page.
  </p>

  <div class="container">
    <img src="../images/grid-management-console.jpg" alt="View of the SeLion Grid Management Console">
  </div>

  <h3 id="restart nodes">Restarting Nodes Manually</h3>
  <p>
    SeLion node processes are automatically restarted after the the number of
    <code>uniqueSessionCount</code>
    sessions occur. If you would like to manually force restarting a node, click <u>Force Restart Nodes</u>.
  </p>
  <div class="container">
    <img src="../images/node-restart.jpg" alt="View of the Restart Node page">
  </div>

  <h3 id="download-json-importance">SeLion Grid Dependency Downloader</h3>
  <p>
    When you host a grid or spawn a node, SeLion Grid will download the artifacts specified in the file
    <code>$SELION_HOME/config/download.json</code>. Artifact details in this file include the name, platform, url,
    and the checksum.
  </p>
  <p>
    Furthermore, if you want to upgrade the SeLion nodes you can click on the <b>Auto Upgrade Nodes</b> link from the
    SeLion Grid Management Console. This link presents a form and the download.json file for you to modify per your needs.
    Once submitted, the grid relays the new artifact details to all nodes registered with the SeLion Grid.
    The nodes then receive the information, clean any old artifacts, downloading the new artifacts, and come back online.
    Note: For this capability to work, the hub and every node which you want to upgrade must be running the SeLion Enhanced Grid.
  </p>
  <h4>Sample download.json file</h4>
  <pre data-src="../sample-files/download.json" class="language-markup"></pre>

  <h3 id="selionNodeConsole">Node Console</h3>
  <p>
    You can click on <u>View Node Logs</u> or directly access the url
    <kbd>http://localhost:4444/grid/admin/ListAllNodes</kbd>.
    This servlet lets you view statistics on all of your nodes in a quick fashion. Some of the information here is
    already presented in selenium's console view. The advantages of this servlet is the load time is very fast. You can
    see the uptime for the various nodes, the number of sessions that have ran on a node since the last auto restart,
    etc.
  </p>
  <div class="container">
    <img src="../images/node-console.jpg" alt="View of the Node Console page">
  </div>

  <h3 id="selionGridStatistics">Browser Statistics</h3>
  <p>
    The GridStatistics servlet displays the current load on the Grid per browser, i.e., the number of requests waiting
    on the queue for a browser and the maximum instances of that browser. The servlet responds only to client using
    accept header for all media types and accept header of type application/json. This is useful if your grid has more
    load than what your nodes can handle. You can programmatically hit this and check for browsers that have sessions
    waiting in queue.<br>
    <br>
    Sample request:<br>
    curl -s -X GET http://localhost:4444/grid/admin/GridStatistics<br>
    Sample response:<br>
    <pre data-src="../sample-files/gridstatisticsresponse.json" class="language-markup"></pre>
  </p>
</div>
<script src="../js/prismjs-min.js"></script>
